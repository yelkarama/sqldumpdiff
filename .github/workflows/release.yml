name: Release

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  go-build:
    name: Go (${{ matrix.os }} ${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    env:
      CGO_ENABLED: "1"
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: darwin
            arch: arm64
            runner: macos-14
          - os: windows
            arch: amd64
            runner: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Setup MSYS2 (windows amd64)
        if: matrix.os == 'windows' && matrix.arch == 'amd64'
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          path-type: inherit
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-pkgconf
      - name: Build (non-windows)
        if: matrix.os != 'windows'
        shell: bash
        run: |
          set -euo pipefail
          cd go
          OUT="sqldumpdiff-${{ matrix.os }}-${{ matrix.arch }}"
          GOOS="${{ matrix.os }}" GOARCH="${{ matrix.arch }}" go build -ldflags="-s -w" -o "$OUT" ./cmd/sqldumpdiff
          mkdir -p dist
          cp "$OUT" "dist/${OUT}"
      - name: Build (windows)
        if: matrix.os == 'windows'
        shell: msys2 {0}
        run: |
          set -euo pipefail
          cd go
          OUT="sqldumpdiff-${{ matrix.os }}-${{ matrix.arch }}.exe"
          GOOS="${{ matrix.os }}" GOARCH="${{ matrix.arch }}" go build -ldflags="-s -w" -o "$OUT" ./cmd/sqldumpdiff
          mkdir -p dist
          cp "$OUT" "dist/${OUT}"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: go-${{ matrix.os }}-${{ matrix.arch }}
          path: go/dist/*

  java-build:
    name: Java (jar + native)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "25"
      - name: Build JAR
        run: |
          cd java
          mvn -q -DskipTests package
          mkdir -p dist
          cp target/sqldumpdiff-1.0.0.jar dist/sqldumpdiff.jar
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: sqldumpdiff-jar
          path: java/dist/sqldumpdiff.jar

  java-native-linux:
    name: Java Native (linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: "25"
          distribution: "graalvm"
          components: "native-image"
      - name: Build native image
        run: |
          cd java
          mvn -q -Pnative -DskipTests -Dnative-image.args="-H:+UnlockExperimentalVMOptions --gc=G1" package
          mkdir -p dist
          cp target/sqldumpdiff dist/sqldumpdiff-linux-native
      - name: Upload native artifact (linux)
        uses: actions/upload-artifact@v4
        with:
          name: java-native-linux
          path: java/dist/sqldumpdiff-linux-native

  python-pypi:
    name: Python (PyPI)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Build package
        run: |
          cd python
          python -m pip install --upgrade pip build twine
          python -m build
          python -m twine check dist/*
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.12.3
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: python/dist
          skip-existing: true

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [go-build, java-build, java-native-linux, python-pypi]
    steps:
      - uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          sha256sum * > SHA256SUMS.txt
      - name: Create/Update nightly tag
        uses: actions/github-script@v7
        with:
          script: |
            const tag = "nightly";
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;
            // Create or update tag reference
            try {
              await github.rest.git.updateRef({
                owner, repo,
                ref: `tags/${tag}`,
                sha,
                force: true,
              });
            } catch (e) {
              await github.rest.git.createRef({
                owner, repo,
                ref: `refs/tags/${tag}`,
                sha,
              });
            }
      - name: Create/Update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: "Nightly"
          body: |
            Automated build from `main`.
            Commit: ${{ github.sha }}
          files: |
            dist/**
          prerelease: true
